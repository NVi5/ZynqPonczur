#include <glm/matrix.hpp>
#include <glm/gtx/transform.hpp>
#include <glm/gtc/matrix_transform.hpp>
#include <glm/gtx/transform.hpp>

#include <math.h>

#include "xparameters.h"
#include "netif/xadapter.h"
#include "platform.h"
#include "platform_config.h"
#include "lwip/tcp.h"
#include "xil_cache.h"
#include "lwip/init.h"

#include "websocket.h"

#include <stdlib.h>

#define GPU_MEM (((uint32_t*)XPAR_GPU_CONTROL_0_S00_AXI_BASEADDR)+0x14)
uint32_t *gpu_mem = GPU_MEM-0x14;
uint32_t write[10] = {0xffffffff, 0, 1, 2, 3, 4, 5, 6, 7, 8};
uint32_t read[10];

int32_t test[] = {168,-176,-168,1,248,-48,-152,1,256,-100,-108,1,-4,-92,-224,1,96,-72,-132,1,84,-32,-152,1,216,-24,-108,1,256,-100,-108,1,248,-48,-152,1,220,-68,-72,1,96,-72,-132,1,100,-104,-100,1,96,-72,-132,1,16,-180,-160,1,100,-104,-100,1,16,-180,-160,1,40,-164,-244,1,48,-216,-196,1,128,188,-188,1,92,196,-108,1,124,156,-136,1,44,48,-164,1,-24,-44,-236,1,64,8,-164,1,220,-68,-72,1,100,-132,-60,1,220,-100,-28,1,8,-140,-196,1,24,-104,-276,1,40,-164,-244,1,12,-212,-116,1,48,-216,-196,1,48,-256,-140,1,0,40,292,1,-140,52,256,1,-108,-12,276,1,216,-24,-108,1,228,4,-188,1,200,16,-136,1,40,-164,-244,1,140,-52,-256,1,160,-120,-220,1,140,-52,-256,1,200,68,-204,1,228,4,-188,1,200,16,-136,1,200,68,-204,1,180,64,-148,1,108,12,-276,1,24,-104,-276,1,0,-40,-292,1,-48,0,-236,1,-72,72,-276,1,-36,16,-292,1,200,16,-136,1,64,8,-164,1,84,-32,-152,1,84,-32,-152,1,-24,-44,-236,1,-4,-92,-224,1,-112,80,-200,1,16,88,-152,1,-8,116,-132,1,108,12,-276,1,168,132,-204,1,200,68,-204,1,152,112,-148,1,64,8,-164,1,180,64,-148,1,72,80,-276,1,128,188,-188,1,168,132,-204,1,152,-156,196,1,12,-196,220,1,56,-236,168,1,-24,-44,-236,1,-36,16,-292,1,0,-40,-292,1,108,12,-276,1,-36,16,-292,1,72,80,-276,1,168,132,-204,1,124,156,-136,1,152,112,-148,1,28,144,-256,1,-36,16,-292,1,-72,72,-276,1,-112,120,-244,1,-140,108,-164,1,-152,156,-196,1,152,112,-148,1,16,88,-152,1,44,48,-164,1,44,48,-164,1,-80,44,-224,1,-48,0,-236,1,-168,124,-120,1,-32,140,-100,1,-56,156,-64,1,28,144,-256,1,88,236,-156,1,128,188,-188,1,-8,116,-132,1,124,156,-136,1,92,196,-108,1,88,236,-156,1,-56,236,-168,1,48,268,-108,1,-40,164,244,1,-168,176,168,1,-160,120,220,1,-80,44,-224,1,-112,120,-244,1,-72,72,-276,1,28,144,-256,1,-112,120,-244,1,-12,196,-220,1,88,236,-156,1,60,224,-72,1,92,196,-108,1,-56,236,-168,1,-112,120,-244,1,-152,156,-196,1,-168,124,-120,1,-220,180,-76,1,-188,176,-140,1,92,196,-108,1,-32,140,-100,1,-8,116,-132,1,-8,116,-132,1,-140,108,-164,1,-112,80,-200,1,-92,152,20,1,-192,128,-68,1,-76,160,-20,1,-56,236,-168,1,12,292,-52,1,48,268,-108,1,-56,156,-64,1,60,224,-72,1,32,240,-28,1,12,292,-52,1,-128,264,-36,1,-12,296,8,1,-48,216,196,1,-168,220,104,1,-168,176,168,1,-140,108,-164,1,-188,176,-140,1,-152,156,-196,1,-152,156,-196,1,-96,260,-108,1,-56,236,-168,1,4,92,224,1,-40,164,244,1,-24,104,276,1,32,240,-28,1,-12,296,8,1,8,240,16,1,-128,264,-36,1,-188,176,-140,1,-220,180,-76,1,-220,100,28,1,-240,172,-12,1,-208,120,-16,1,-56,156,-64,1,8,240,16,1,-76,160,-20,1,-56,156,-64,1,-192,128,-68,1,-168,124,-120,1,-128,264,-36,1,-36,284,76,1,-12,296,8,1,-92,152,20,1,8,240,16,1,-4,232,68,1,-152,252,32,1,-48,256,140,1,-36,284,76,1,-220,180,-76,1,-208,120,-16,1,-240,172,-12,1,-220,180,-76,1,-152,252,32,1,-128,264,-36,1,-36,284,76,1,-12,212,116,1,-4,232,68,1,-252,144,48,1,-152,252,32,1,-240,172,-12,1,-256,100,108,1,-220,100,28,1,-220,68,72,1,-100,132,60,1,-4,232,68,1,-12,212,116,1,-220,100,28,1,-92,152,20,1,-100,132,60,1,12,-296,-8,1,152,-252,-32,1,128,-264,36,1,72,-72,276,1,-72,-80,276,1,-28,-144,256,1,-160,120,220,1,-256,100,108,1,-248,48,152,1,-8,140,196,1,-48,216,196,1,-40,164,244,1,-168,176,168,1,-252,144,48,1,-256,100,108,1,256,-100,-108,1,220,-100,-28,1,252,-144,-48,1,-100,104,100,1,-12,212,116,1,-16,180,160,1,-220,68,72,1,-100,132,60,1,-100,104,100,1,-152,-112,148,1,-200,-68,204,1,-180,-64,148,1,48,0,236,1,0,40,292,1,36,-16,292,1,-96,72,132,1,-16,180,160,1,-8,140,196,1,-216,24,108,1,-100,104,100,1,-96,72,132,1,-216,24,108,1,-256,100,108,1,-220,68,72,1,-24,104,276,1,-160,120,220,1,-140,52,256,1,-108,-12,276,1,-228,-4,188,1,-200,-68,204,1,24,44,236,1,-24,104,276,1,0,40,292,1,-140,52,256,1,-248,48,152,1,-228,-4,188,1,-84,32,152,1,-8,140,196,1,4,92,224,1,-200,-16,136,1,-96,72,132,1,-84,32,152,1,-88,-236,156,1,-124,-156,136,1,-92,-196,108,1,112,-80,200,1,72,-72,276,1,112,-120,244,1,-64,-8,164,1,4,92,224,1,24,44,236,1,-180,-64,148,1,-84,32,152,1,-64,-8,164,1,-200,-68,204,1,-200,-16,136,1,-180,-64,148,1,36,-16,292,1,-108,-12,276,1,-72,-80,276,1,-28,-144,256,1,-168,-132,204,1,-128,-188,188,1,72,-72,276,1,48,0,236,1,36,-16,292,1,-168,-132,204,1,-108,-12,276,1,-200,-68,204,1,-44,-48,164,1,24,44,236,1,48,0,236,1,-44,-48,164,1,-180,-64,148,1,-64,-8,164,1,-12,-292,52,1,-60,-224,72,1,-32,-240,28,1,168,-124,120,1,152,-156,196,1,188,-176,140,1,-16,-88,152,1,48,0,236,1,80,-44,224,1,-124,-156,136,1,-44,-48,164,1,-16,-88,152,1,-124,-156,136,1,-168,-132,204,1,-152,-112,148,1,112,-120,244,1,-28,-144,256,1,12,-196,220,1,56,-236,168,1,-88,-236,156,1,-48,-268,108,1,140,-108,164,1,112,-120,244,1,152,-156,196,1,12,-196,220,1,-128,-188,188,1,-88,-236,156,1,8,-116,132,1,80,-44,224,1,112,-80,200,1,-92,-196,108,1,-16,-88,152,1,8,-116,132,1,12,-296,-8,1,4,-232,-68,1,36,-284,-76,1,208,-120,16,1,220,-180,76,1,240,-172,12,1,140,-108,164,1,8,-116,132,1,112,-80,200,1,-60,-224,72,1,8,-116,132,1,32,-140,100,1,-48,-268,108,1,-92,-196,108,1,-60,-224,72,1,188,-176,140,1,56,-236,168,1,96,-260,108,1,128,-264,36,1,-12,-292,52,1,12,-296,-8,1,192,-128,68,1,188,-176,140,1,220,-180,76,1,96,-260,108,1,-48,-268,108,1,-12,-292,52,1,56,-156,64,1,140,-108,164,1,168,-124,120,1,56,-156,64,1,-60,-224,72,1,32,-140,100,1,168,-220,-104,1,256,-100,-108,1,252,-144,-48,1,4,-232,-68,1,48,-256,-140,1,36,-284,-76,1,192,-128,68,1,56,-156,64,1,168,-124,120,1,-8,-240,-16,1,56,-156,64,1,76,-160,20,1,12,-296,-8,1,-32,-240,28,1,-8,-240,-16,1,240,-172,12,1,128,-264,36,1,152,-252,-32,1,240,-172,12,1,220,-100,-28,1,208,-120,16,1,4,-232,-68,1,76,-160,20,1,92,-152,-20,1,192,-128,68,1,92,-152,-20,1,76,-160,20,1,152,-252,-32,1,252,-144,-48,1,240,-172,12,1,168,-220,-104,1,36,-284,-76,1,48,-256,-140,1,208,-120,16,1,100,-132,-60,1,92,-152,-20,1,4,-232,-68,1,100,-132,-60,1,12,-212,-116,1,48,268,-108,1,32,240,-28,1,60,224,-72,1,-12,296,8,1,-4,232,68,1,8,240,16,1,160,-120,-220,1,228,4,-188,1,248,-48,-152,1,-16,180,160,1,-48,256,140,1,-48,216,196,1,168,-176,-168,1,40,-164,-244,1,160,-120,-220,1,168,-176,-168,1,48,-256,-140,1,48,-216,-196,1,84,-32,-152,1,216,-24,-108,1,200,16,-136,1,-4,-92,-224,1,0,-40,-292,1,24,-104,-276,1,200,68,-204,1,152,112,-148,1,180,64,-148,1,-228,-4,188,1,-216,24,108,1,-200,-16,136,1,16,-180,-160,1,100,-132,-60,1,100,-104,-100,1,220,-180,76,1,96,-260,108,1,128,-264,36,1,168,-176,-168,1,160,-120,-220,1,248,-48,-152,1,-4,-92,-224,1,8,-140,-196,1,96,-72,-132,1,216,-24,-108,1,220,-68,-72,1,256,-100,-108,1,220,-68,-72,1,216,-24,-108,1,96,-72,-132,1,96,-72,-132,1,8,-140,-196,1,16,-180,-160,1,16,-180,-160,1,8,-140,-196,1,40,-164,-244,1,128,188,-188,1,88,236,-156,1,92,196,-108,1,44,48,-164,1,-48,0,-236,1,-24,-44,-236,1,220,-68,-72,1,100,-104,-100,1,100,-132,-60,1,8,-140,-196,1,-4,-92,-224,1,24,-104,-276,1,12,-212,-116,1,16,-180,-160,1,48,-216,-196,1,0,40,292,1,-24,104,276,1,-140,52,256,1,216,-24,-108,1,248,-48,-152,1,228,4,-188,1,40,-164,-244,1,24,-104,-276,1,140,-52,-256,1,140,-52,-256,1,108,12,-276,1,200,68,-204,1,200,16,-136,1,228,4,-188,1,200,68,-204,1,108,12,-276,1,140,-52,-256,1,24,-104,-276,1,-48,0,-236,1,-80,44,-224,1,-72,72,-276,1,200,16,-136,1,180,64,-148,1,64,8,-164,1,84,-32,-152,1,64,8,-164,1,-24,-44,-236,1,-112,80,-200,1,-80,44,-224,1,16,88,-152,1,108,12,-276,1,72,80,-276,1,168,132,-204,1,152,112,-148,1,44,48,-164,1,64,8,-164,1,72,80,-276,1,28,144,-256,1,128,188,-188,1,152,-156,196,1,112,-120,244,1,12,-196,220,1,-24,-44,-236,1,-48,0,-236,1,-36,16,-292,1,108,12,-276,1,0,-40,-292,1,-36,16,-292,1,168,132,-204,1,128,188,-188,1,124,156,-136,1,28,144,-256,1,72,80,-276,1,-36,16,-292,1,-112,120,-244,1,-112,80,-200,1,-140,108,-164,1,152,112,-148,1,124,156,-136,1,16,88,-152,1,44,48,-164,1,16,88,-152,1,-80,44,-224,1,-168,124,-120,1,-140,108,-164,1,-32,140,-100,1,28,144,-256,1,-12,196,-220,1,88,236,-156,1,-8,116,-132,1,16,88,-152,1,124,156,-136,1,88,236,-156,1,-12,196,-220,1,-56,236,-168,1,-40,164,244,1,-48,216,196,1,-168,176,168,1,-80,44,-224,1,-112,80,-200,1,-112,120,-244,1,28,144,-256,1,-72,72,-276,1,-112,120,-244,1,88,236,-156,1,48,268,-108,1,60,224,-72,1,-56,236,-168,1,-12,196,-220,1,-112,120,-244,1,-168,124,-120,1,-192,128,-68,1,-220,180,-76,1,92,196,-108,1,60,224,-72,1,-32,140,-100,1,-8,116,-132,1,-32,140,-100,1,-140,108,-164,1,-92,152,20,1,-208,120,-16,1,-192,128,-68,1,-56,236,-168,1,-96,260,-108,1,12,292,-52,1,-56,156,-64,1,-32,140,-100,1,60,224,-72,1,12,292,-52,1,-96,260,-108,1,-128,264,-36,1,-48,216,196,1,-48,256,140,1,-168,220,104,1,-140,108,-164,1,-168,124,-120,1,-188,176,-140,1,-152,156,-196,1,-188,176,-140,1,-96,260,-108,1,4,92,224,1,-8,140,196,1,-40,164,244,1,32,240,-28,1,12,292,-52,1,-12,296,8,1,-128,264,-36,1,-96,260,-108,1,-188,176,-140,1,-220,100,28,1,-252,144,48,1,-240,172,-12,1,-56,156,-64,1,32,240,-28,1,8,240,16,1,-56,156,-64,1,-76,160,-20,1,-192,128,-68,1,-128,264,-36,1,-152,252,32,1,-36,284,76,1,-92,152,20,1,-76,160,-20,1,8,240,16,1,-152,252,32,1,-168,220,104,1,-48,256,140,1,-220,180,-76,1,-192,128,-68,1,-208,120,-16,1,-220,180,-76,1,-240,172,-12,1,-152,252,32,1,-36,284,76,1,-48,256,140,1,-12,212,116,1,-252,144,48,1,-168,220,104,1,-152,252,32,1,-256,100,108,1,-252,144,48,1,-220,100,28,1,-100,132,60,1,-92,152,20,1,-4,232,68,1,-220,100,28,1,-208,120,-16,1,-92,152,20,1,12,-296,-8,1,36,-284,-76,1,152,-252,-32,1,72,-72,276,1,36,-16,292,1,-72,-80,276,1,-160,120,220,1,-168,176,168,1,-256,100,108,1,-8,140,196,1,-16,180,160,1,-48,216,196,1,-168,176,168,1,-168,220,104,1,-252,144,48,1,256,-100,-108,1,220,-68,-72,1,220,-100,-28,1,-100,104,100,1,-100,132,60,1,-12,212,116,1,-220,68,72,1,-220,100,28,1,-100,132,60,1,-152,-112,148,1,-168,-132,204,1,-200,-68,204,1,48,0,236,1,24,44,236,1,0,40,292,1,-96,72,132,1,-100,104,100,1,-16,180,160,1,-216,24,108,1,-220,68,72,1,-100,104,100,1,-216,24,108,1,-248,48,152,1,-256,100,108,1,-24,104,276,1,-40,164,244,1,-160,120,220,1,-108,-12,276,1,-140,52,256,1,-228,-4,188,1,24,44,236,1,4,92,224,1,-24,104,276,1,-140,52,256,1,-160,120,220,1,-248,48,152,1,-84,32,152,1,-96,72,132,1,-8,140,196,1,-200,-16,136,1,-216,24,108,1,-96,72,132,1,-88,-236,156,1,-128,-188,188,1,-124,-156,136,1,112,-80,200,1,80,-44,224,1,72,-72,276,1,-64,-8,164,1,-84,32,152,1,4,92,224,1,-180,-64,148,1,-200,-16,136,1,-84,32,152,1,-200,-68,204,1,-228,-4,188,1,-200,-16,136,1,36,-16,292,1,0,40,292,1,-108,-12,276,1,-28,-144,256,1,-72,-80,276,1,-168,-132,204,1,72,-72,276,1,80,-44,224,1,48,0,236,1,-168,-132,204,1,-72,-80,276,1,-108,-12,276,1,-44,-48,164,1,-64,-8,164,1,24,44,236,1,-44,-48,164,1,-152,-112,148,1,-180,-64,148,1,-12,-292,52,1,-48,-268,108,1,-60,-224,72,1,168,-124,120,1,140,-108,164,1,152,-156,196,1,-16,-88,152,1,-44,-48,164,1,48,0,236,1,-124,-156,136,1,-152,-112,148,1,-44,-48,164,1,-124,-156,136,1,-128,-188,188,1,-168,-132,204,1,112,-120,244,1,72,-72,276,1,-28,-144,256,1,56,-236,168,1,12,-196,220,1,-88,-236,156,1,140,-108,164,1,112,-80,200,1,112,-120,244,1,12,-196,220,1,-28,-144,256,1,-128,-188,188,1,8,-116,132,1,-16,-88,152,1,80,-44,224,1,-92,-196,108,1,-124,-156,136,1,-16,-88,152,1,12,-296,-8,1,-8,-240,-16,1,4,-232,-68,1,208,-120,16,1,192,-128,68,1,220,-180,76,1,140,-108,164,1,32,-140,100,1,8,-116,132,1,-60,-224,72,1,-92,-196,108,1,8,-116,132,1,-48,-268,108,1,-88,-236,156,1,-92,-196,108,1,188,-176,140,1,152,-156,196,1,56,-236,168,1,128,-264,36,1,96,-260,108,1,-12,-292,52,1,192,-128,68,1,168,-124,120,1,188,-176,140,1,96,-260,108,1,56,-236,168,1,-48,-268,108,1,56,-156,64,1,32,-140,100,1,140,-108,164,1,56,-156,64,1,-32,-240,28,1,-60,-224,72,1,168,-220,-104,1,168,-176,-168,1,256,-100,-108,1,4,-232,-68,1,12,-212,-116,1,48,-256,-140,1,192,-128,68,1,76,-160,20,1,56,-156,64,1,-8,-240,-16,1,-32,-240,28,1,56,-156,64,1,12,-296,-8,1,-12,-292,52,1,-32,-240,28,1,240,-172,12,1,220,-180,76,1,128,-264,36,1,240,-172,12,1,252,-144,-48,1,220,-100,-28,1,4,-232,-68,1,-8,-240,-16,1,76,-160,20,1,192,-128,68,1,208,-120,16,1,92,-152,-20,1,152,-252,-32,1,168,-220,-104,1,252,-144,-48,1,168,-220,-104,1,152,-252,-32,1,36,-284,-76,1,208,-120,16,1,220,-100,-28,1,100,-132,-60,1,4,-232,-68,1,92,-152,-20,1,100,-132,-60,1,48,268,-108,1,12,292,-52,1,32,240,-28,1,-12,296,8,1,-36,284,76,1,-4,232,68,1,160,-120,-220,1,140,-52,-256,1,228,4,-188,1,-16,180,160,1,-12,212,116,1,-48,256,140,1,168,-176,-168,1,48,-216,-196,1,40,-164,-244,1,168,-176,-168,1,168,-220,-104,1,48,-256,-140,1,84,-32,-152,1,96,-72,-132,1,216,-24,-108,1,-4,-92,-224,1,-24,-44,-236,1,0,-40,-292,1,200,68,-204,1,168,132,-204,1,152,112,-148,1,-228,-4,188,1,-248,48,152,1,-216,24,108,1,16,-180,-160,1,12,-212,-116,1,100,-132,-60,1,220,-180,76,1,188,-176,140,1,96,-260,108,1};
uint32_t len = 3456;
uint8_t framebuffer[2][800*600];

void lwip_init();
extern "C" {
	void tcp_fasttmr(void);
	void tcp_slowtmr(void);
}

extern volatile int TcpFastTmrFlag;
extern volatile int TcpSlowTmrFlag;
static struct netif server_netif;
struct netif *echo_netif;

void glm_mat4_to_fpga(glm::mat4 &mat, uint32_t *fpga_addr) {
	for (int i = 0; i < 4; i++) {
		for (int j = 0; j < 4; j++) {
				fpga_addr[4*i+j] = (int32_t)(mat[j][i] * 128.0f);
		}
	}
}

void onOpen (websocket_t *websocket){}

float alfa = 0.0f;
float beta = 0.0f;
float gamm = 0.0f;

void onMessage (websocket_t *websocket, websocket_frame_t * frame){
	if (frame->opcode == websocket_opcode_binary) {
		float *data = (float*)frame->data;

		if (data[0] != 1.337f) {
			alfa = data[0];
			beta = data[1];
			gamm = data[2];

		}
	}
}

void onClose (websocket_t *websocket){}

uint8_t ponczur [4800*10] = {0};

int main()
{
	Xil_DCacheDisable();
	ip_addr_t ipaddr, netmask, gw;
	unsigned char mac_ethernet_address[] = { 0x00, 0x0a, 0x35, 0x00, 0x01, 0x02 };
	echo_netif = &server_netif;
	init_platform();
	IP4_ADDR(&ipaddr,  172, 16,   0, 10);
	IP4_ADDR(&netmask, 255, 255, 255, 0);
	IP4_ADDR(&gw,      172, 16,   0,  1);
	lwip_init();
	if (!xemac_add(echo_netif, &ipaddr, &netmask, &gw, mac_ethernet_address, PLATFORM_EMAC_BASEADDR)) {
		return -1;
	}
	netif_set_default(echo_netif);
	platform_enable_interrupts();
	netif_set_up(echo_netif);

	websocket_t *xd = new_websocket(&ipaddr, 1000);
	xd->onopen = (websocket_onopen_fn)onOpen;
	xd->onmessage = (websocket_onmessage_fn)onMessage;
	xd->onclose = (websocket_onclose_fn)onClose;


	for (unsigned int i = 0; i < len; i++) {
		test[i] = test[i] << 7;
	}

	int current_framebuffer = 0;

	memcpy(GPU_MEM, test, len*sizeof(test[0]));
	gpu_mem[0x10] = len;
	gpu_mem[0x11] = (uint32_t)framebuffer[current_framebuffer];

	#define N_PONCZUR 5
	int data_size = 0;
	unsigned int buffer_pos = 0;

	while (1) {
		if (TcpFastTmrFlag) {
			tcp_fasttmr();
			TcpFastTmrFlag = 0;
		}
		if (TcpSlowTmrFlag) {
			tcp_slowtmr();
			TcpSlowTmrFlag = 0;
		}

		if (xd->status == websocket_status_open) {
			if (data_size <= 0){
				data_size = 480000;

				//alfa += 0.1;

				while(!gpu_mem[0x13]);
				if (current_framebuffer == 0) current_framebuffer = 1;
				else current_framebuffer = 0;
				gpu_mem[0x11] = (uint32_t)framebuffer[current_framebuffer];

				glm::mat4 Projection = glm::perspective(glm::radians(90.0f), 4.0f / 3.0f, 0.1f, 1.0f);
				glm::mat4 View = glm::lookAt(
				    glm::vec3(0,0,-500.0f), // Camera is at (4,3,3), in World Space
				    glm::vec3(0,0,0), // and looks at the origin
				    glm::vec3(0,1,0)  // Head is up (set to 0,-1,0 to look upside-down)
				);
				glm::mat4 Model = glm::rotate(glm::mat4(1.0f), alfa, glm::vec3(1.0f, 0.0f, 0.0f));
				Model = glm::rotate(Model, beta, glm::vec3(0.0f, 1.0f, 0.0f));
				Model = glm::rotate(Model, gamm, glm::vec3(0.0f, 0.0f, 1.0f));
				glm::mat4 MVP = Projection * View * Model;

				glm_mat4_to_fpga(MVP, gpu_mem);
				gpu_mem[0x12] = 1;
			}


			ponczur[0] = buffer_pos&0x000000ff;
			ponczur[1] = (buffer_pos&0x0000ff00)>>8;
			ponczur[2] = (buffer_pos&0x00ff0000)>>16;
			ponczur[3] = (buffer_pos&0xff000000)>>24;
			uint8_t *framebuffer_ptr = NULL;
			if (current_framebuffer == 0) framebuffer_ptr = framebuffer[1];
			else framebuffer_ptr = framebuffer[0];
			memcpy(&ponczur[4],(void*)&framebuffer_ptr[buffer_pos], 4800*N_PONCZUR);

			err_t err = websocket_send_binary(xd, ponczur, 4+(4800*N_PONCZUR));
			if (err == 0) {
				data_size -= 4800*N_PONCZUR;
				buffer_pos = (4800*N_PONCZUR + buffer_pos) % (800*600);
			}
		}

		xemacif_input(echo_netif);
	}

	return 0;
}
